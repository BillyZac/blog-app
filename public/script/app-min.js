function loadBlogs(){$.get(server+"blogs").done(function(e){e.forEach(function(e){e.summary=e.body.length>50?e.body.substring(0,50)+"...":e.body});var o=Handlebars.compile(Handlebars.partials.blogsview);$(".main").html(o({blogs:e,compareId:localStorage.templateId}))}),loading()}function loadBlog(e){Promise.all([$.get(server+"blogs/"+e),$.get(server+"blogs/"+e+"/comments")]).then(function(e){var o=e[1].concat(e[0]),t=[];o.forEach(function(e){e.updated_at=formatDate(e.updated_at);var o=Number(e.user_id);e.compareId=localStorage.templateId,t[o]||(t[o]=new Promise(function(e,t){$.get(server+"users/"+o).done(function(o){e(o)})}))});var a=Handlebars.compile(Handlebars.partials.blogview),n=stack(e[1]);Promise.all(t).then(function(t){o.concat(e[0]).forEach(function(e){var o=Number(e.user_id);e.user=t[o]}),$(".main").html(a({blogs:[e[0]],comments:n}))})}),loading()}function newBlog(){editBlog("undefined","Create Blog","postBlog")}function editBlog(e,o,t){var a=Handlebars.compile(Handlebars.partials.blogform),n=$(".modular"),l=$(".blog-title").text(),r=$(".blog-content").text();n.html(a({title:l,body:r,submitText:o||"Update Blog",method:t||"putBlog",params:e})),$("#title").val(l),n.removeClass("hidden")}function postBlog(e){e.preventDefault();var o=getFormData("form");$.ajax({url:server+"blogs/",method:"post",data:o}).done(function(e){loadBlogs()}),$(".modular").html("").addClass("hidden")}function putBlog(e,o){e.preventDefault();var t=getFormData("form");$.ajax({url:server+"blogs/"+o,method:"put",data:t}).done(function(e){loadBlog(o)}),$(".modular").html("").addClass("hidden")}function deleteBlog(e){var o=Handlebars.compile(Handlebars.partials.modularform),t=$(".modular");t.html(o({prompt:"Are you sure you want to delete this blog post (this process cannot be undone)?",method:"deleteBlogConfirmed",params:e})),t.removeClass("hidden")}function deleteBlogConfirmed(e,o){e.preventDefault(),$.ajax({url:server+"blogs/"+o,method:"delete"}).done(function(e){loadBlogs()})}function addComment(e,o,t,a,n){var l=Handlebars.compile(Handlebars.partials.commentform),r=$(".modular"),i=[e];o&&i.push(o);var m=n?$(n).text():"";r.html(l({submitText:t||"Add Comment",method:a||"postComment",params:i.join(),body:m||""})),r.removeClass("hidden")}function postComment(e,o,t){e.preventDefault();var a=getFormData("form");t&&(a.commentId=t),$.ajax({url:server+"blogs/"+o+"/comments",method:"post",data:a}).done(function(e){loadBlog(o)}),$(".modular").html("").addClass("hidden")}function editComment(e){addComment(e,void 0,"Update Comment","putComment",".comment-body--"+e)}function putComment(e,o){e.preventDefault();var t=getFormData("form"),a=$(".blog-title").data().blog;$.ajax({url:server+"blogs/"+a+"/comments/"+o,method:"put",data:t}).done(function(e){loadBlog(a)}),$(".modular").html("").addClass("hidden")}function deleteComment(e){var o=Handlebars.compile(Handlebars.partials.modularform),t=$(".modular");t.html(o({prompt:"Are you sure you want to delete this comment (this process cannot be undone)?",method:"deleteCommentConfirmed",params:e})),t.removeClass("hidden")}function deleteCommentConfirmed(e,o){e.preventDefault();var t=$(".blog-title").data().blog;$.ajax({url:server+"blogs/"+t+"/comments/"+o,method:"delete"}).done(function(e){console.log(e),loadBlog(t)})}function promisifyPartial(e){return new Promise(function(o,t){$.get(e.file).done(function(t){Handlebars.registerPartial(e.name,t),o(!0)}).fail(function(e){t(e)})})}function promiseToLoad(){return new Promise(function(e){$(document).ready(function(){e(!0)})})}function stack(e,o,t){var a=e.filter(function(e){return e.comment_id==o});return a.forEach(function(o){o.level=t||0,o.subcomments=stack(e,o.id,o.level+1)}),a}function loading(){$(".main").html('<p class="loading">Loading...</p>')}function cancel(e){e.preventDefault(),$(".modular").addClass("hidden")}function logOut(){localStorage.clear(),$.get(server+"auth/logout").done(function(e){window.location.reload(!0)})}function sendLogIn(e){e.preventDefault();var o=getFormData("form");o.email&&o.password&&$.ajax({url:server+"auth/login",method:"post",data:o}).done(function(e){e.success?(localStorage.templateId=e.userId,window.location.reload(!0)):console.log(e)}),$(".modular").html("").addClass("hidden")}function logIn(){var e=Handlebars.compile(Handlebars.partials.loginform),o=$(".modular");o.html(e({method:"sendLogIn",submitText:"Log In"})),o.removeClass("hidden")}function sendSignUp(e){e.preventDefault();var o=getFormData("form");o.handle&&o.email&&o.password&&$.ajax({url:server+"auth/signup",method:"post",data:o}).done(function(e){e.success?$.ajax({url:server+"auth/login",method:"post",data:o}).done(function(e){e.success?(localStorage.templateId=e.userId,window.location.reload(!0)):console.log(e)}):console.log(e)}),$(".modular").html("").addClass("hidden")}function signUp(e){e&&e.preventDefault();var o=Handlebars.compile(Handlebars.partials.loginform),t=$(".modular");t.html(o({method:"sendSignUp",submitText:"Sign Up",needsHandle:!0})),t.removeClass("hidden")}function getFormData(e){var o={};return Array.prototype.forEach.call($(e).children(),function(e){"INPUT"===e.tagName?o[e.id]=e.value:"TEXTAREA"===e.tagName&&(o[e.id]=e.value||e.innerHTML)}),o}function formatDate(e){var o=new Date(e),t=String(o.getYear()+1900),a=zeroPad(o.getMonth()+1,2),n=zeroPad(o.getDate(),2),l=o.getHours(),r=zeroPad(o.getMinutes(),2),i=zeroPad(o.getSeconds(),2),m=[[t,a,n].join("-")].concat([l,r,i].join(":")).join(" ");return m}function zeroPad(e,o){for(var t=String(e);t.length<o;)t="0"+t;return t}Promise.all([promisifyPartial({name:"blog",file:"/templates/blog.hbs"}),promisifyPartial({name:"comment",file:"/templates/comment.hbs"}),promisifyPartial({name:"summary",file:"/templates/summary.hbs"}),promisifyPartial({name:"blogview",file:"/templates/blog-view.hbs"}),promisifyPartial({name:"blogsview",file:"/templates/blogs-view.hbs"}),promisifyPartial({name:"blogform",file:"/templates/blog-form.hbs"}),promisifyPartial({name:"commentform",file:"/templates/comment-form.hbs"}),promisifyPartial({name:"modularform",file:"/templates/modular-form.hbs"}),promisifyPartial({name:"loginform",file:"/templates/login-form.hbs"}),promiseToLoad()]).then(loadBlogs),Handlebars.registerHelper("compare",function(e,o,t){return e==o?t.fn(this):t.inverse(this)});var server="/";$(document).ready(function(){document.cookie.split("userId=").length>1?$(".logo").append('<button class="nav-button log-out" onclick="logOut();">Log Out</button>'):($(".logo").append('<button class="nav-button log-in" onclick="logIn();">Log In</button>'),$(".logo").append('<button class="nav-button sign-up" onclick="signUp();">Sign Up</button>'))});